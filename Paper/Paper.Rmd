---
title: "The Impact of Loadshedding on SWIX Sectors using DCC-GARCH models"
documentclass: "elsarticle"
Thesis_FP: FALSE
output:
  pdf_document:
    keep_tex: TRUE
    template: Tex/TexDefault.txt
    fig_width: 3.5
    fig_height: 3.5
    
Author1: 'Sven Wellmann'
Ref1: "Stellenbosch University, Stellenbosch, South Africa"
Email1: '20850980\@sun.ac.za'

BottomRFooter: "\\footnotesize Page \\thepage"
addtoprule: TRUE
addfootrule: TRUE

margin: 2.3
bottom: 2
top: 2.5
HardSet_layout: TRUE

linenumbers: FALSE

bibliography: Tex/ref.bib
csl: Tex/harvard-stellenbosch-university.csl

RemovePreprintSubmittedTo: TRUE
Journal: "Journal of Finance"

toc: FALSE # Table of Contents

numbersections: TRUE

fontsize: 11pt
linestretch: 1.2
link-citations: TRUE

AddTitle: TRUE

#abstract: |
#  Abstract
---

<!-- First: Set your default preferences for chunk options: -->

<!-- If you want a chunk's code to be printed, set echo = TRUE. message = FALSE stops R printing ugly package loading details in your final paper too. I also suggest setting warning = FALSE and checking for warnings in R, else you might find ugly warnings in your paper. -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')
# Note: Include = FALSE implies the code is executed, but not printed in your pdf.
# warning and message = FALSE implies ugly messages and warnings are removed from your pdf.
# These should be picked up when you execute the command chunks (code sections below) in your rmd, not printed in your paper!

pacman::p_load(modelsummary, gt, knitr, kableExtra, tidyverse, lubridate, tinytex, rmarkdown, crypto2, quantmod, MTS, rmgarch, rugarch, tbl2xts, fmxdat, ggthemes, summarytools, vars, tseries, pander, cowplot, qpcR, tidyquant, stargazer, data.table, xtable)

list.files('code/', full.names = T, recursive = T) %>% as.list() %>% walk(~source(.))

list.files('../code/', full.names = T, recursive = T) %>% as.list() %>% walk(~source(.))
```


```{r eval=FALSE, include=FALSE}
# Alsi_returns <- read_rds("/Users/svenwellmann/Downloads/Alsi_Returns.rds")
# Alsi_returns %>% pull(date) %>% max
```


```{r include=FALSE}
ALSI <- read_rds("../data/Alsi_Returns.rds")

ALSIsel <- ALSI %>% dplyr::select(date, Tickers, Return, J200, Sector)

ALSI_df <- ALSIsel %>% filter(!is.na(J200)) %>% filter(date>= "2014-01-01")

sectors <- ALSI_df %>% pull(Sector) %>% unique()

sector_return <- list()
for(i in 1:length(sectors)){
    # Loop through sectors and calculate returns and cumulative returns
    sector_return[[i]] <- portfolio_return_function_alsi(ALSI_df, sector = sectors[i]) %>% 
      mutate(cumreturn_Rand = (cumprod(1 + Returns))) %>% # Start at 1
      mutate(cumreturn_Rand = cumreturn_Rand/dplyr:::first(cumreturn_Rand)) %>% 
      mutate(Sector = sectors[i])
}

# Rename tibbles
names(sector_return) <- sectors

# Combine Dataframes
sectors_cum_return <- rbind(sector_return[[1]], sector_return[[2]], sector_return[[3]], sector_return[[4]]) %>% arrange(date)
```


<!-- ############################## -->
<!-- # Start Writing here: -->
<!-- ############################## -->

# Introduction \label{Introduction}

Financial markets have become largely interconnected causing a multitude of issues for investors trying to diversify investment portfolios. The homogeneity of asset price movements across sectors within geographical borders has increased. These co-movements are shown to become stronger during times of economic uncertainty or after a shock to the system. To avoid significant drawdowns many investors diversify their portfolios, attempting to limit any loss caused directly to a stock, sector or region. Diversification is difficult when the shocks affects a larger grouping of financial assets, as witnessed with COVID-19 where investors around the world saw a significant portion of their portfolios disappear. 

This analysis focuses on a country specific systemic shock for South Africa. Eskom, South Africa's main power provider, has failed to maintain a stable power output that matches the demand of the South African population. Thus, Eskom has introduced load-shedding. Load-shedding is a scheduled power cut, leaving parts of the population without power. Load-shedding has had deep impact on businesses in South Africa and this paper looks specifically at how load-shedding has affected the diversification properties of different financial sectors within South Africa. The dynamic nature of how sectors co-move will be observed for times where load-shedding is present and compare that to the entire sample.

Firstly, the analysis is conducted with a static view of correlations between sectors. Then the time-varying conditional correlations between the different sectors will be assessed using the Dynamic Conditional Correlation (DCC) Multivariate Autoregressive Conditional Heteroskedasticity (MV-GARCH) model proposed by @engle2002. 

This paper finds that static estimates of correlation between asset returns across local economic sectors falls short. Alongside this, the dynamic correlations are observed to vary significantly across the entire sample period. Load-shedding increases the measures of conditional correlation for specific sector pairs and seems to have little effect on other sector pairs. In summary this paper looks to give investors a better understanding of how the presence of load-shedding will affect the diversification structure of the South African financial market.

# Literature Review

First, provide an overview of the DCC model, including its purpose, methodology and key assumptions. Discuss the motivations for using a DCC model in finance, such as the need to capture the time-varying dependence structure between multiple time series. Highlight the key features of the GJR specification, and explain how it can effectively capture fat tails, excess kurtosis and leverage effects.

To assess the effect of load-shedding on the different sectors of the All Share Index (ALSI), the volatility of the time series has to be assessed. Modelling and explaining the dynamics of volatility of financial time-series starts with @engle's work on the Autoregressive Conditional Heteroskedasticity (ARCH) models. These models have subsequently improved over the last 3 decades, with the DCC model by @engle2002 and the Asymmetric DCC model by @cappiello2006asymmetric. These models bring statistical benefits by controlling for the second order persistence. It will be shown in this study how important it is to not just take a static view of correlation and rather model the conditional correlation. These models take into account dynamics that previous models could not, allowing better decision making for investors. MV-GARCH models have garnered attention, followed by a large body of literature extending and transforming the models to capture the dynamics of the time-series. 

The literature on MV-GARCH techniques has focused on the increasing interdependence between various financial markets. South Africa is often studied as a composite in the dynamics of emerging economies. In this context, studies have shown that herding behaviour among investors during periods of economic uncertainty can significantly impact the linkages between developing countries' capital markets and developed economies. For example, @horvath2013international used the BEKK MV-GARCH model to examine the conditional correlations between main sectors in several large economies, including South Africa. Similarly, @corsetti2005some and @chiang2007dynamic utilized the DCC MV-GARCH model to examine this issue.

Several studies have also investigated return and volatility co-movements between South Africa and other markets. For example, @samouilhan2006 used univariate volatility models to examine market and sector-level return and volatility co-movements between South Africa and the UK stock market. @chinzara2009dynamic used VAR modelling techniques and univariate GARCH models to study cross-country correlations between South Africa's stock market index and several other large global indices. In a similar vein, @chinzara2011macroeconomic investigated the spillover effects of macroeconomic indicators on the returns of the South African stock market index and four sectors (financial, retail, mining, and industrial) during crisis periods such as the Asian crisis and the financial crisis.

In a separate study, @bonga2018uncovering investigates the transmission of financial shocks between South Africa and other members of the BRICS grouping during the period 1996-2012. The study utilizes a multivariate VAR-DCC-GARCH model and finds evidence of cross-transmission and dependence between South Africa and Brazil. However, the results suggest that South Africa is more affected by crises originating from China, India, and Russia, while these countries are least affected by crises originating from South Africa.

Finally, @katzke studied the dynamics of return co-movements between South Africa's largest sectors in order to highlight the potential gains from inter-sector diversification for domestic investors. The study utilized both the DCC-GARCH and Asymmetric DCC-GARCH models and showed that diversification opportunities across sectors are limited during periods of elevated market uncertainty.

The literature is focused on periods of market uncertainty and crises. South Africa is currently experiencing, and has previously been victim of, an energy crisis. The energy crisis is due to a shortfall in electricity generation capacity and a lack of investment in the country's power infrastructure. Load-shedding is a measure taken by the state-owned electricity utility, Eskom, to manage the country's power grid and prevent widespread blackouts. Load-shedding is quite a unique crisis and thus lacks an abundance of literature, although the effects are obviously damaging. However, load-shedding has been implemented in Pakistan. @XU2022100849  analyse the impact of an energy crisis on the profitability and productivity of 424 non-financial listed companies in Pakistan over the period of load-shedding, 2001 to 2017. The results from this study confirm the negative impact of load-shedding on business profitability and productivity @XU2022100849. The effects of load-shedding affect all industries and @siddiqui2008cost find that small businesses are worst affected. 

@kessides2013chaos investigate the damage that electricity shortages have had on Pakistan's economy. @kessides2013chaos find that load-shedding constrains any economic growth and has significant negative shocks on employment, exports and poverty alleviation. The also find that the industrial, commercial and agricultural businesses that utilise the national power have been crippled from the outages forcing a significant reduction in the level of output.  The damage from load-shedding is significant in electricity-intensive sectors, such as the industrial sector. @kessides2013chaos suggest that the costs are split between directs costs such as production lost, spoilage costs, process restart costs and damage to machinery, and indirect costs arising from adjustments made by firms trying to recover output. 

This paper seeks to add to the literature by showing how local energy uncertainty influence the dynamics of conditional co-movement between the
largest domestic economic sectors. The paper provides an interesting insight into the ability of domestic investors manage their portfolios during periods where the domestic economy is affected by the shortcomings of Eskom. 


```{r eval=FALSE, include=FALSE, results='asis'}
summstats_all <- xts_alsi_return %>% 
  descr(stats = c("mean", "med", "sd", "min", "max", "skewness", "kurtosis", "n.valid"), round.digits = 4, order = c("Financials", "Industrials", "Resources"))

rownames(summstats_all) <- c("Mean", "Median", "Std.Dev", "Min", "Max", "Skewness", "Kurtosis", "Observations" )

round(summstats_all,4) %>% kable() %>% kable_styling(font_size = 9)
```


```{r eval=FALSE, include=FALSE, results='asis'}
summstats_loadshed <- xts_alsi_return_loadshed %>% 
  descr(stats = c("mean", "med", "sd", "min", "max", "skewness", "kurtosis", "n.valid"), round.digits = 4, order = c("Financials", "Industrials", "Resources", "Property"))

rownames(summstats_loadshed) <- c("Mean", "Median", "Std.Dev", "Min", "Max", "Skewness", "Kurtosis", "Observations" )

round(summstats_loadshed,4) %>% kable() %>% kable_styling(font_size = 9)
```


```{r eval=FALSE, include=FALSE, results='asis'}
summstats_no_loadshed <- xts_alsi_return_no_loadshed %>% 
  descr(stats = c("mean", "med", "sd", "min", "max", "skewness", "kurtosis", "n.valid"), round.digits = 4, order = c("Financials", "Industrials", "Resources", "Property"))

rownames(summstats_no_loadshed) <- c("Mean", "Median", "Std.Dev", "Min", "Max", "Skewness", "Kurtosis", "Observations" )

round(summstats_no_loadshed,4) %>% kable() %>% kable_styling(font_size = 9)
```


# Data \label{Data}

The aim of this project is to construct time-varying conditional correlations between different sectors of the ALSI. These co-movements between sectors are then analysed over a stratified period where South Africa was affected by load-shedding. This study utilises a series of daily returns and weights of stocks in the ALSI, which are then filtered into either the Industrial, Financial, Resource or Property sector. Sector returns are calculated on a daily level and then the entire data set is subset into months than South Africa experienced load-shedding and months where it did not. The sample period of the data is from 1 January 2014 until 31 October 2022. 

The sector returns are plotted in Figure \ref{CumRet} where it is visible that the sectors show characteristics of co-movement, especially during market shocks. This is evident with the onset of COVID-19 in March of 2020 where all sectors demonstrate a significant drawback in cumulative returns. Since this downturn in 2020, the Resource sector has grown significantly while Property has not been able to recover to pre-pandemic levels. 

```{r CumRet,  warning =  FALSE, fig.align = 'center', fig.cap = "Cumulative Returns per Sector for ALSI and SWIX \\label{CumRet}", fig.ext = 'png', fig.height = 3, fig.width = 6}

sectors_cum_return_plot <- sectors_cum_return %>% 
  ggplot() +
  geom_line(aes(date, cumreturn_Rand, colour = Sector), alpha = 0.8) + 
  #facet_wrap(~Sector) + 
  fmxdat::fmx_cols() + 
  labs(title = "", y = "Cumulative Returns", x = "") + 
  fmxdat::theme_fmx(title.size = ggpts(25))
sectors_cum_return_plot

```

```{r include=FALSE}
alsi_loadshed <- rbind(
sectors_cum_return %>% filter(date >= "2014-11-01" & date <= "2015-3-31"),
sectors_cum_return %>% filter(date >= "2019-02-01" & date <= "2019-3-31"),
sectors_cum_return %>% filter(date >= "2019-12-01" & date <= "2020-3-31"),
sectors_cum_return %>% filter(date >= "2021-3-01" & date <= "2021-6-30"),
sectors_cum_return %>% filter(date >= "2021-9-01" & date <= "2021-11-30"),
sectors_cum_return %>% filter(date >= "2022-2-01" & date <= "2022-4-30"),
sectors_cum_return %>% filter(date >= "2022-6-01" & date <= "2022-12-31"))

alsi_no_loadshed <- sectors_cum_return %>% filter(!date %in% (alsi_loadshed %>% pull(date)))

sectors_cum_return_wide <- sectors_cum_return %>% dplyr:::select(date, Returns, Sector) %>% spread(key = "Sector", value = "Returns")
sectors_cum_return_nona <- impute_missing_returns(sectors_cum_return_wide, impute_returns_method = "Drawn_Distribution_Collective")
xts_alsi_return <- sectors_cum_return_nona %>%  tbl_xts() 

alsi_loadshed_wide <- alsi_loadshed %>% dplyr:::select(date, Returns, Sector) %>% spread(key = "Sector", value = "Returns")
alsi_loadshed_nona <- impute_missing_returns(alsi_loadshed_wide, impute_returns_method = "Drawn_Distribution_Collective")
xts_alsi_return_loadshed <- alsi_loadshed_nona %>%  tbl_xts()

alsi_no_loadshed_wide <- alsi_no_loadshed %>% dplyr:::select(date, Returns, Sector) %>% spread(key = "Sector", value = "Returns")
alsi_no_loadshed_nona <- impute_missing_returns(alsi_no_loadshed_wide, impute_returns_method = "Drawn_Distribution_Collective")
xts_alsi_return_no_loadshed <- alsi_no_loadshed_nona %>%  tbl_xts()

# Get DCC fits

fit.dcc = readRDS(file = "../fit.dcc.rds")
fit.dcc_ls = readRDS(file = "../fit.dcc_ls.rds")
fit.dcc_nls = readRDS(file = "../fit.dcc_nls.rds")

RcovList <- rcov(fit.dcc)  # This is now a list of the monthly covariances of our DCC model series.
RcovList_ls <- rcov(fit.dcc_ls)
RcovList_nls <- rcov(fit.dcc_nls)

covmat = matrix(RcovList, nrow(xts_alsi_return), ncol(xts_alsi_return) * ncol(xts_alsi_return), byrow = TRUE)
covmat_ls = matrix(RcovList, nrow(xts_alsi_return_loadshed), ncol(xts_alsi_return_loadshed) * ncol(xts_alsi_return_loadshed), byrow = TRUE)
covmat_nls = matrix(RcovList, nrow(xts_alsi_return_no_loadshed), ncol(xts_alsi_return_no_loadshed) * ncol(xts_alsi_return_no_loadshed), byrow = TRUE)

mc1 = MCHdiag(xts_alsi_return, covmat)
mc1_ls = MCHdiag(xts_alsi_return_loadshed, covmat_ls)
mc1_nls = MCHdiag(xts_alsi_return_no_loadshed, covmat_nls)

dcc.time.var.cor <- rcor(fit.dcc)
dcc.time.var.cor_ls <- rcor(fit.dcc_ls)
dcc.time.var.cor_nls <- rcor(fit.dcc_nls)

dcc.time.var.cor <- aperm(dcc.time.var.cor, c(3, 2, 1))
dcc.time.var.cor_ls <- aperm(dcc.time.var.cor_ls, c(3, 2, 1))
dcc.time.var.cor_nls <- aperm(dcc.time.var.cor_nls, c(3, 2, 1))

dim(dcc.time.var.cor) <- c(nrow(dcc.time.var.cor), ncol(dcc.time.var.cor)^2)
dim(dcc.time.var.cor_ls) <- c(nrow(dcc.time.var.cor_ls), ncol(dcc.time.var.cor_ls)^2)
dim(dcc.time.var.cor_nls) <- c(nrow(dcc.time.var.cor_nls), ncol(dcc.time.var.cor_nls)^2)

dcc.time.var.cor <- renamingdcc(ReturnSeries = xts_alsi_return, DCC.TV.Cor = dcc.time.var.cor)
dcc.time.var.cor_ls <- renamingdcc(ReturnSeries = xts_alsi_return_loadshed, DCC.TV.Cor = dcc.time.var.cor_ls)
dcc.time.var.cor_nls <- renamingdcc(ReturnSeries = xts_alsi_return_no_loadshed, DCC.TV.Cor = dcc.time.var.cor_nls)

```

## Summary Statistics

Summary statistics for the series of daily sector returns are shown in Table \ref{table1}. Resources show the largest average daily return ($\mu =  0.0005$) for the sample period, while Property shows the lowest average daily return ($\mu =  0$). The largest standard deviation belongs to the Resource sector, indicating that it has the largest volatility from a historical and static perspective. The Property sector has both the largest daily drawdown and the largest daily recovery over the sample period, at -19.35\% and 15.49\%. All of the sectors show negatively skewed tails, indicating that large negative returns are more likely than large positive returns for this sample period. Property exhibits a high degree of kurtosis, having its distribution concentrated around the mean. The Jarque-Bera test is used to assess whether the daily returns follow a normal distribution. The significance stars in Table \ref{table1} below indicate that the null hypothesis of normality in the sampled returns is rejected for all sectors at a 1\% significance level.


```{r table1, results='asis'}
summstat_table <- summary_stats(sectors_cum_return_nona) 
summstat_table
```

## Serial Autocorrelation and ARCH Effects

The Ljung-Box test is used to examine the data for serial autocorrelation over longer time periods, therefore a lag length of 10 is used. The results in Table \ref{table1} show that the null hypothesis of no autocorrelation can be rejected, requiring autoregressive terms in the mean equations to be fitted on all of the data. To supplement the Ljung-Box test, Figure \ref{LogRet} plots the daily returns. Figure \ref{LogRet} displays periods of volatility clustering, otherwise known as market momentum. This is a strong indication of second order persistence in the time series, pointing to autoregressive conditional heteroskedasticity (ARCH) effects and long memory that require explicit modelling of the variance components. 

@engle LM-GARCH test confirms the presence of ARCH effects in all the series using:
$$\epsilon_t^2= \beta_0 + (\Sigma_{s = 1}^{10}\beta_s\epsilon_{t-s}^2) + v_t $$. To control for these ARCH effects, @engle showed that it is possible to simultaneously model the mean and variance equations of a series using GARCH models. This technique will be further utilized to extract the time-varying conditional correlations of our time series data.

```{r LogRet,  warning =  FALSE, fig.align = 'center', fig.cap = "Log Returns per Sector for the SWIX \\label{LogRet}", fig.ext = 'png', fig.height = 3, fig.width = 6}

log_returns_plot <- sectors_cum_return %>% mutate(Sector = factor(Sector, levels = c("Financials",  "Industrials", "Property", "Resources"))) %>% 
  ggplot() + geom_line(aes(x = date, y = Returns, colour = Sector, alpha = 1)) + 
facet_wrap(~Sector, scales = "free_y", nrow = 3) + 
guides(alpha = "none") + 
fmxdat::theme_fmx() +
labs(x = "", y = "", subtitle = " ") +
theme(legend.position = "none") +
scale_color_hue(l = 20) + 
scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 years") + 
theme(axis.text = element_text(size = 7))

log_returns_plot

```

## Co-Integration Tests

The next step is to test for co-integration in order to motivate the study of the time series conditional correlations. The @johansen1988 co-integration test will be used to confirm whether there is at least one linear long-run relationship among the time series that would yield stationary residuals. The Johansen co-integration test uses a Vector Error Correction Model (VECM) approach with the form:

\begin{align}
  \Delta p_t = \prod p_{t-k} + \Gamma_1 p_{t-1} + \Gamma_2 p_{t-2} + ... + \Gamma_{7} p_{t-7} + \mu + \delta (t) + \theta D_t + \epsilon_t \label{eq1}
\end{align}

where $p_t$ is a $(1 \times 4)$ vector of the daily returns for the sectors at time $t$. The Johansen test centres around the examination of the $\prod$-matrix. The $\prod$-matrix has form $\prod = \alpha \beta^{'}$ where $\beta$ is the $k^{th}$ order co-integrating vector and $\alpha$ is the adjustment parameter. Below the Trace and Maximum Eigenvalue tests are used to consider the rank of the $\prod$-matrix using its eigenvalues. The rank will give an indication of long-run dependence. The Trace statistic tests whether the number of co-integrating vectors of the system is less than or equal to 4, while the Max-Eigenvalue statistic reflects separate tests used on each eigenvalue of the $\prod$-matrix. If the tests indicate that the rank of $\prod$ is statistically likely to be greater than 0, it would imply that there is co-integration and a long-run relationship between the variables. 

The findings from the Trace test is that all relationships are co-integrating at the 1\% significance level. The Eigenvalue test is conducted and confirms this result. This could indicate that the sectors have a common underlying factor that affects their movements. The co-integrating relationship represents correlation between the time series processes in the long term and validates the necessity to study these co-movements. 

```{r eval=FALSE, include=FALSE}
lag.select <- VARselect(xts_alsi_return, lag.max = 10, type = "const")

ctest1 <- ca.jo(xts_alsi_return, type = "trace", ecdet = "const", K = 10, spec = "transitory")

summary(ctest1)
```


## Unconditional Coerrelation

Table \ref{corrtab} gives the unconditional correlation of returns of the sectors for the entire period as well as for the unconditional correlation for the period where South Africa experienced load-shedding.

These static estimates of historic correlation are often used in practice but have many limitations. The unconditional correlations are limited by the sample period and do not account for any changes. Therefore they do not accurately reflect the relationships between the time series at specific points in time. In this section, it has been observed that the time series data of the sector returns display both first and second order serial autocorrelation. Thus the static estimates of correlation are misleading when the mean persistence and conditional heteroskedasticity is not controlled for. Static estimates of correlation also fail to take into account the dynamic nature of the underlying correlations. In the next section the underlying correlations conditional on past information will be studied.

```{r corrtab, results='asis'}
corr_mat <- cor(xts_alsi_return)

corr_mat_ls <- cor(xts_alsi_return_loadshed)

corr_mat[upper.tri(corr_mat)] <- corr_mat_ls[upper.tri(corr_mat_ls)]

kable(round(corr_mat,4), caption = "Static Unconditional Correlation \\label{corrtab}") %>% kable_styling(font_size = 9) %>%
   add_footnote("Note: This table provides correlation for daily returns of the different sectors over the whole period (bottom left) and just the periods of load-shedding (top right).", notation="none") 
```


# Methodology \label{Meth}

## DCC Model

The goal of this study is to examine the dynamic correlations between the Industrial, Financial, Property and Resource sectors of the ALSI as well as to understand how these correlations change over time. To achieve this goal, the DCC (Dynamic Conditional Correlation) model is used. The DCC model is a statistical model that is commonly used to analyse the correlations between multiple time series data. It consists of two components: a GARCH (Generalized Autoregressive Conditional Heteroscedasticity) model, which is used to model the variance of the time series data, and a dynamic conditional correlation model, which is used to model the correlations between the time series.

To estimate the DCC model the maximum likelihood estimation procedure is used. This involves specifying the functional form of the model, including the functional form of the GARCH and dynamic conditional correlation components. Then estimating the parameters of the model that maximize the likelihood of the data given the model. The DCC model has been widely used in the literature to study dynamic correlations in financial markets.

This study will use the sector daily returns, a $1 \times 4$ stochastic vector $\{r_t\}$. The DCC model is specified as follows: 

\begin{align}
  r_{it} = \mu_{it} + \epsilon_{it} \label{eq2}
\end{align}

\begin{align}
  \epsilon_{it} = \sqrt{H_{it}}. \eta_i  \text{  with  } \epsilon_{it} \sim N(0, H_t)  \text{  and  } \eta_i \sim N(0, I) . \label{eq3}
\end{align}

Where $\mu_t$ is the unconditional AR(1)-mean equation, $\epsilon_t$ the vector of ordinary residuals, $H_t$ the $N \times N$ conditional covariance matrix and $\eta_i$ the standardised residuals. 

Various MV-GARCH models have been proposed to model the covariance process, $H_t$, in Equation \ref{eq3}. The DCC model will be used in this paper which allows the covariance matrix to be separated into different univariate volatility equations and their respective conditional correlations. 

The covariance matrix in the DCC-Model is defined as follows:

\begin{align}
  H_t = D_tR_tD_t \label{eq4}
\end{align}

with $D_t = diag(\sqrt{h_{11,t}}...\sqrt{h_{NN,t}})$ and $h_{ii,t}$ taking the functional form of the univariate GARCH model specified. The dynamic conditional correlation structure is then given by the following equation:

\begin{align}
  Q_{ij,t} = (1 - \theta_1 - \theta_2).\bar{Q} + \theta_1(\epsilon_{i,t-1}\epsilon_{j,t-1}^{'}) + \theta_2(Q_{ij,t-1})  \label{eq5}
\end{align}

where $Q_{ij,t}$ is the unconditional variance between different series $i$ and $j$, $\bar{Q}$ is the unconditional covariance between the series estimated in the univariate GARCH specification and estimation step. The scalar parameters $\theta_1$ and $\theta_2$ must satisfy both the non negativity assumption $\theta_1 \geq 0$ and $\theta_2 \geq 0$ as well as the assumption that $\theta_1 + \theta_2 < 1$. The second step the requires only the estimate of $\theta_1$ and $\theta_2$ using a likelihood function. Equation \ref{5} expresses the unconditional variance matrix, $Q_{ij,t}$, as a standard GARCH-type equation, so that we can derive the dynamic conditional correlation matrix, $R_t$, between any two series as: 

\begin{align}
  R_t = Q_{ij,t}^{*-1}. Q_{ij,t}. Q_{ij,t}^{*-1} \label{eq6}
\end{align}

with $Q_{ij,t}^{*}$ a diagonal matrix with the square root of the diagonal elements of $Q_{ij,t}$ as its entries, such that $Q_{ij,t}^{*} = Diag(Q_t)^{1/2}$. This process can be thought of intuitively as multiplying both sides of Equation \ref{6} by the inverse of Diagonal matrix $D_t$. The dynamic conditional correlation matrix, $R_{ij,t}$ will therefore have entries in the bivariate framework as follows: 

\begin{align}
  \rho_{ij,t} = \dfrac{q_{ij,t}}{\sqrt{q_{ii,t}.q_{jj,t}}} \\ 
  = \dfrac{(1 - \theta_1 - \theta_2) \bar{q} + \theta_1 \epsilon_{i,t-1} \epsilon_{j,t-1}^{'} + \theta_2 q_{ij,t-1}}{((1 - \theta_1 - \theta_2)\bar{q_i} + \theta_1     \epsilon_{i,t-1}^2 + \theta_2 q_{ii,t-1}) . ((1 - \theta_1 - \theta_2) \bar{q_{j}} + \theta_1 \epsilon_{j,t-1}^2 + \theta_2 q_{jj,t-1})} \label{eq7}
\end{align}

Following the methodology of @engle2002, the DCC model is estimated by maximising the log-likelihood function for Equation \ref{eq2} as: 

\begin{align}
  L(\theta, \phi) = -\dfrac{1}{2} \sum_{t=1}^T (ln(2\pi) + ln(\left|D_tR_tD_t\right|) + \epsilon_t^{'}(D_tR_tD_t)^{-1}\epsilon_t)  \label{eq8}
\end{align}

and using the fact that $H_t = D_tR_tD_t$, Equation \ref{eq8} can be simplified as:

\begin{align}
  L(\theta, \phi) = -\dfrac{T}{2} ln(2\pi) - \dfrac{1}{2} . \sum_{t=1}^T (2 . ln \left| D_t \right| + \epsilon_t^{'} (D_tD_t)^{-1} \epsilon_t) - \dfrac{1}{2}\sum_{t=1}^T (ln\left| R_t \right| + \epsilon_t^{'} (R_t^{-1}) \epsilon_t)  \label{eq9}
\end{align}

The second step is then to maximise the correlation part by using the maximised value in the equation above to solve:

\begin{align}
  L_C(\theta, \phi) = -\dfrac{1}{2}\sum_{t=1}^T (ln\left| R_t \right| + \epsilon_t^{'} (R_t^{-1}) \epsilon_t) \label{eq10}
\end{align}

The two-stage DCC estimation procedure outlined above has parameter estimates that are both consistent and asymptotically normal. @cappiello2006asymmetric find a clear limitation of the DDC, that the dynamics of the conditional correlation do not account for asymmetric effects. This means that although the model accounts for the magnitude of past shocksâ€™ impact on future conditional volatility and correlation, it does not differentiate between positive and negative shock effects. This limitation will not be resolved in this study. \footnote{In order to account for these effects the Asymmetric Dynamic Conditional Correlation (ADCC) was created, for more information follow Capiello \emph{et al.} (2006) or Engle (1995)}

After the GARCH model is fit at a univariate level, the dynamic conditional correlation series will be fit for each bi-variate relationship. This dynamic structure of the returns of each sector pair of Resources, Financials, Property and Industrials will be explored further.

## Univariate Specification

The first stage in building the DCC model framework consists of fitting univariate GARCH specifications to each series of returns. The univariate GARCH model fit on the data is the GJR-GARCH [@glosten1993relation]. Table \ref{univar} below contains the chosen univariate GJR-GARCH fit.

The Univariate GARCH model includes: 

Mean equation:
\begin{align}
  r_t = \mu + a_1. r_{t-1} + \epsilon_t  \label{eq11}
\end{align}

Volatility equation:

\begin{align}
  \epsilon_t = \sqrt{h_t}.\eta_t, \quad \text{where} \eta_t \sim N(0,1)  \label{eq12}
\end{align}

where $r_t$ is the daily return for a sector at time $t$, $\mu$ is the unconditional mean of the time series and $a_1$ is the coefficient for the autoregressive term in the mean equation. The conditional variance at time $t$, $h_t$, is modelled as a function of the variance at previous time periods and the error term at previous time periods. The random error term, $\epsilon_t$, is multiplied by the square root of the conditional variance to ensure that the variance is always positive. The standardized error term, $\eta_t$, has a mean of 0 and a standard deviation of 1. Equation \ref{eq12} specifies the relationship between the error term $\epsilon_t$ and the conditional variance $h_t$. 

The GJR-GARCH model is a variant of the GARCH model that can effectively capture fat tails, excess kurtosis, and leverage effects, allowing for more flexibility in modelling the time-varying variance. In the GJR-GARCH(1,1) model, the variance at time $t$ is modelled as:

\begin{align}
  h_t = \beta_0 + \beta_1 \epsilon_{t-1}^2 + \gamma . I[\epsilon_{t-1}<0] \circ \epsilon_{t-1}^2 + \beta_2 h_{t-1}  \label{eq13}
\end{align}

This model combines elements of both the ARCH and GARCH models, and different model specifications can be obtained by varying the parameters $\gamma$ and $\beta_1$. For example, setting $\gamma = 0$ results in a GARCH model. 

The parameter $\gamma$ in GJR-GARCH model reflects the leverage effect, which refers to the phenomenon where the magnitude of the response of the variance to a shock depends on the sign of the shock. A positive value of $\gamma$ indicates that negative shocks tend to have a larger impact on the variance than positive shocks of the same magnitude, while a negative value of $\gamma$ indicates the opposite. This model specifications allow the GJR-GARCH model to capture different responses of the variance to positive and negative shocks, which can be important for accurately modelling time series data that exhibits asymmetry.

Table \ref{univar} shows that the returns series for all sectors display strong persistence in volatility and both ARCH and GARCH effects, as measured by $(\alpha_1 + \beta_2 )$. This indicates volatility clustering. The statistical significance of the $\beta_2$ parameter for all sectors in the GJF-GARCH model indicates a strong presence of conditional heteroskedasticity. This is consistent with the results of @engle LM-GARCH test run in section \ref{Data} and confirms the presence of ARCH effects. This further suggests that the static measures of return correlations between sector returns in the last section are not reliable.

The main takeaway from Table \ref{univar} comes from the $\alpha_1$ and $\beta_2$ parameters, which can be used to assess the persistence of volatility in the time series. $\alpha_1$ measures the contribution of past shocks to the current variance, while $\beta_1$ measures the contribution of the past variance to the current variance. A positive value of $\alpha_1$ indicates that positive shocks tend to be followed by more volatility than negative shocks of a similar magnitude, while a negative value of $\alpha_1$ indicates the opposite. Table \ref{univar} shows that Financials and Industrials have a negative value for $\alpha_1$ indicating an asymmetry where negative shocks have a larger impact on volatility than positive shocks. Property and Resources both have positive values for $\alpha_1$. Similarly, a positive value of $\beta_2$ indicates that high levels of volatility tend to persist over time, while a negative value of $\beta_2$ indicates that high levels of volatility tend to dissipate over time. All sectors have a significant and positive $\beta_2$. All sectors also have a positive and significant $\gamma$ indicating that negative shocks tend to have a larger impact on the variance than positive shocks of the same magnitude.

To estimate the time-varying DCC model, the next step is to extract the standardized residuals from the estimated GJR GARCH model and maximize the log-likelihood function. This allows for the estimation of the time-varying conditional correlations between the sectors of the ALSI.

```{r univar, results='asis'}
coef_output <- list()
coef_output_pval <- list()

for (p in 1:length(colnames(xts_alsi_return))) { 
  
    garchfit = ugarchspec(
      variance.model = list(model = "gjrGARCH", garchOrder = c(1, 1)), mean.model = list(armaOrder = c(1, 0), include.mean = TRUE), 
      distribution.model = c("norm", "snorm", "std", "sstd", "ged", "sged", "nig", "ghyp", "jsu")[4])
  
    garchfit1 = ugarchfit(spec = garchfit, data=as.numeric(xts_alsi_return[,p])) 
  
    coef_output[[p]] = garchfit1@fit$matcoef[,1] 
    coef_output_pval[[p]] = garchfit1@fit$matcoef[,4] 
}

coef_table <-  cbind(c("Financials", "",  "Industrials", "", "Property", "", "Resources", "") , bind_rows(coef_output[[1]], coef_output_pval[[1]], coef_output[[2]], coef_output_pval[[2]], coef_output[[3]], coef_output_pval[[3]], coef_output[[4]], coef_output_pval[[4]]))

coef_table_plot <- coef_table %>%
  kable(col.names = c("Sector", "$a_0$", "$a_1$", "$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\gamma$", "Skewness", "Shape"), escape = FALSE, digits = 4, caption = "Univariate GJR GARCH Coefficients \\label{univar}") %>% kable_styling(latex_options = c("HOLD_position", "scale_down"), protect_latex = TRUE) %>% 
   add_footnote("Note: This table provides the univariate GJR GARCH model coefficients with the p-values underneath.", notation="none") 

coef_table_plot
```

```{r include=FALSE}
dcc.time.var.cor_ls <- dcc.time.var.cor_ls %>% mutate(Period = case_when(date >= "2014-11-01" & date <= "2015-3-31" ~ "Period 1",
                              date >= "2019-02-01" & date <= "2019-3-31" ~ "Period 2",
                              date >= "2019-12-01" & date <= "2020-3-31" ~ "Period 3",
                              date >= "2021-3-01" & date <= "2021-6-30" ~ "Period 4",
                              date >= "2021-9-01" & date <= "2021-11-30" ~ "Period 5",
                              date >= "2022-2-01" & date <= "2022-4-30" ~ "Period 6",
                              date >= "2022-06-01" & date <= "2022-12-31" ~ "Period 7"))
```


# Results

In order to understand the dynamics of the different sectors of the ALSI the DCC models are analysed. The DCC model separates the variance and the correlation structure into two distinct components: the GARCH component, which models the variance of each time series, and the dynamic conditional correlation component, which models the correlations between the time series. This allows the DCC model to capture both the direct and indirect effects of one time series on the variance of another time series. Additionally, the DCC model allows for the dynamic correlations between time series to vary over time. First the results of the fit of the DCC model will be assessed for the whole sample period and for the period including load-shedding. 

## DCC Model Fit

The main conclusion that can be drawn from the fit of the dynamic conditional correlation (DCC) model in Table \ref{dccfitw} is that the beta coefficients, which measure the persistence of the correlation structure, are all close to 0.9. This indicates that the correlation structure between sector returns is relatively persistent over time. Additionally, the dcca coefficient, which measures the conditional mean of the correlation, is 0.0266 suggests that there is a moderate level of dependence between the four sectors. The dccb coefficient, which measures the conditional volatility of the correlation, is 0.9515 and indicates a strong positive dependence. The estimates of the omega coefficients are all zero. The omega coefficients measure the unconditional variance of the residuals, suggesting that any consistent persistence is being captured by the alpha and beta coefficients. The alpha coefficients are all non-significant and have low values. A non-significant alpha indicates that there is no autoregressive effect in the conditional correlation structure. 


```{r dccfitw, results='asis'}
star_fit.dcc <- round(fit.dcc@mfit$matcoef[rownames(fit.dcc@mfit$matcoef) %like% 'omega|alpha1|beta1|dcca1|dccb1',, drop = FALSE], 4) #%>% data.frame()

star_fit.dcc %>% kable(caption = "DCC Model fit over Full Sample Period \\label{dccfitw}")%>% kable_styling(font_size = 9) %>% 
  add_footnote("Note: This table displays the fit of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the full period of this study.", notation="none") 

```

The results of the DCC model fit on the period with load-shedding are displayed in Table \ref{dccfitls}. The main difference between the two models is the amount of data points in the sample, with load-shedding having significantly less observations. The beta values for all sectors are significant yet lower in value. During periods of load-shedding, Property experiences a beta of 0.5314 compared to 0.8854. This change shows a large shift in the persistence of the correlation structure of Property during times of load-shedding. These lower betas could also be due to the different periods not being observed consecutively. The rest of the coefficients are similar to the the results of the DCC fit for the whole period. Thus the models fit the data and the time-varying conditional correlation structure can be visualised and discussed. 


```{r, results='asis'}
star_fit.dcc_ls <- round(fit.dcc_ls@mfit$matcoef[rownames(fit.dcc_ls@mfit$matcoef) %like% 'omega|alpha1|beta1|dcca1|dccb1',, drop = FALSE],4)

star_fit.dcc_ls %>% kable(caption = "DCC Model fit over Period of Load-Shedding \\label{dccfitls}") %>% kable_styling(font_size = 9) %>% 
  add_footnote("Note: This table displays the fit of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the periods that encounter loadshedding in this study.", notation="none")
```

## DCC Figures

The dynamic conditional correlations for the Industrial sector with Resources, Financials and Property is graphed in Figure \ref{DCCfulli}. The pairwise conditional correlations show periods where co-movements between pairs reach close to 80\% and also 0\%. The benefits of using the DCC model in comparison to the unconditional static correlation is evident in the time-varying nature. The 7 periods of load-shedding are highlighted in Figure \ref{DCCfulli}. From observation, the highlighted periods show a tighter correlation structure between all sectors. 

```{r DCCfulli,  warning =  FALSE, fig.align = 'center', fig.cap = "Dynamic Conditional Correlations: Industrials \\label{DCCfulli}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_i_plot <- ggplot(dcc.time.var.cor %>% filter(grepl("Industrials_", Pairs), !grepl("_Industrials", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Industrials") +
  scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 years") + 
  annotate("text", 
           x = c(as.Date("2014-9-01"), as.Date("2018-12-01"), as.Date( "2019-10-01"), as.Date("2021-1-01"), as.Date("2021-08-01"), as.Date("2022-01-01"), as.Date("2023-03-01")), 
           y = 0, 
           label = c("Period 1", "Period 2", "Period 3", "Period 4", "Period 5", "Period 6", "Period 7"),
           angle = 90, 
           size = 9/.pt) +
  xlab("") +
  geom_rect(aes(xmin = as.Date("2014-11-01"), xmax = as.Date("2015-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)  +
  geom_rect(aes(xmin = as.Date("2019-02-01"), xmax = as.Date("2019-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date( "2019-12-01"), xmax = as.Date("2020-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) + 
  geom_rect(aes(xmin = as.Date("2021-3-01"), xmax = as.Date("2021-6-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2021-9-01"), xmax = as.Date("2021-11-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-2-01"), xmax = as.Date("2022-4-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-6-01"), xmax = as.Date("2022-12-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)

dcc.time.var.cor_i_plot

```

This observation is highlighted in Figure \ref{DCClsi}, where the dynamic conditional correlations are graphed for just the periods of load-shedding. Figure \ref{DCClsi} illustrates that the conditional correlations of Industrials with the other sectors change in union. Only period 6 has a significant discrepancy, with the pair of Industrials and Resources having their conditional correlation dynamic inverse to the pairs of Industrials and Financials, and Industrials and Property.  

```{r DCClsi,  warning =  FALSE, fig.align = 'center', fig.cap = "Load-Shedding Dynamic Conditional Correlations: Industrials \\label{DCClsi}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_ls_i_plot <- ggplot(dcc.time.var.cor_ls %>% filter(grepl("Industrials_", Pairs), !grepl("_Industrials", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Industrials", subtitle = "Periods of Loadshedding") +
  facet_grid(~Period, scales = "free_x", space = "free_x") +
  scale_x_date(labels = scales::date_format("%Y %b"), date_breaks = "3 months") + 
  theme(axis.text = element_text(size = 7), strip.text.x = element_text(size = 8)) +
  xlab("") 
  

dcc.time.var.cor_ls_i_plot

```


## DCC Summary Statistics

To further the analysis of the dynamic conditional correlations of the sectors of the ALSI, the summary statistics for the full period and the periods of load-shedding are given in Tables \ref{summstatdccfull} and \ref{summstatdccls}. The main discrepancy between Table \ref{summstatdccfull} and Table \ref{summstatdccls} is for the pairs: 

* Industrials with Resources
* Resources with Properties
* Financials with Property

Overall, the periods of load-shedding see a slight increase in conditional correlation to that of the full period. However, the sector-pairs mentioned above observe a significant increase in conditional correlations during periods of load-shedding. This result could suggest that the underlying relationship between the sectors has changed during these periods, become more pronounced or less pronounced. This result could also suggest that load-shedding is affecting the relationship between the variables during this sample period. The periods of loadshedding are selected at a monthly level and thus do have a limitation of specificity. These periods could be affected by other factors as well as load-shedding. However there is a significant discrepancy. 

```{r, results='asis'}
dccsummstat <- dcc.time.var.cor %>% spread(key = Pairs, value = Rho) %>% dplyr::select(c(Financials_Industrials, Financials_Resources, Financials_Property, Industrials_Resources, Industrials_Property, Resources_Property)) %>% 
  descr(stats = c("mean", "sd", "min", "max"), round.digits = 4)

colnames(dccsummstat) <- c("Financials -> Industrials", "Financials -> Resources", "Financials -> Property", "Industrials -> Resources", "Industrials -> Property", "Resources -> Property")
round(dccsummstat,4) %>%  t() %>% 
  kable(caption = "Summary Statistics of DCC output for the Full Period \\label{summstatdccfull}") %>%
  kable_styling(font_size = 9) %>%
  add_footnote("Note: This table provides summary statistics of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the entire period of this study.", notation="none")

```



```{r, results='asis'}

dccsummstat_ls <- dcc.time.var.cor_ls %>% spread(key = Pairs, value = Rho) %>% dplyr::select(c(Financials_Industrials, Financials_Resources, Financials_Property, Industrials_Resources, Industrials_Property, Resources_Property)) %>% 
  descr(stats = c("mean", "sd", "min", "max"), round.digits = 4)

colnames(dccsummstat_ls) <- c("Financials -> Industrials", "Financials -> Resources", "Financials -> Property", "Industrials -> Resources", "Industrials -> Property", "Resources -> Property")
round(dccsummstat_ls,4) %>%  t() %>% 
  kable(caption = "Summary Statistics of DCC output for Periods of Load-Shedding \\label{summstatdccls}") %>%
  kable_styling(font_size = 9) %>%
  add_footnote("Note: This table provides summary statistics of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the periods that encounter loadshedding in this study.", notation="none")
```

The results from the Dynamic Conditional Correlations (DCC) model show that the volatility of sector returns exhibit strong co-movements, as observed in the Table \ref{summstatdccfull} and illustrated in the Figure \ref{DCCfulli}. The DCC model, which extracts the underlying process and removes noise from the data, reveals lower correlations compared to the static correlations presented in section \ref{Data}. The minimum and maximum values of the correlations tend to occur during times of endogenous and exogenous shocks to the market. This suggests that the market is highly interconnected and exhibits volatility clustering, as found in section \ref{Data}.

# Conclusion

In this paper, we have undertaken an in-depth analysis of the market dynamics of the Industrial, Financial, Property and Resource sectors. Specifically, we have focused on the co-movements and risk spillovers stratified for periods when South Africa experienced load-shedding. 

All sectors demonstrate strong co-movements. These co-movements are tested with static correlation measures of the daily returns. To better understand these co-movements, we have employed a range of statistical techniques to the continuous daily returns for the 4 sectors of the ALSI. Next the GJR GARCH model is fit to the data, which allowed us to account for asymmetries in the return structure. The results of the LM-ARCH test and Cointegration test are significant, indicating short term and long term relationships in the data respectively. This suggests the use of models that can capture dynamics through time as well as models that take into account conditional heteroskedasticity.

Thus, to further understand the dynamics of the data we use the Dynamic Conditional Correlations approach. A significant increase in integration and co-movement between all pairs of assets is found for the sample period of 1 January 2014 to 31 October 2022. These co-movements are also indicative of bidirectional risk spillovers between assets.

Overall, this paper has contributed to our understanding of the complex market dynamics between sectors of the ALSI and the effect that load-shedding plays on sector returns. By examining co-movements and risk spillovers between different sectors for different periods we have gained a more complete picture of the forces at play in the ever evolving financial market.

<!-- Make title of bibliography here: -->
<!-- \newpage -->

\newpage

# References {.unnumbered}

::: {#refs}
:::


# Appendix {.unnumbered}

## DCC Graphs for Full Period


```{r DCCfullr,  warning =  FALSE, fig.align = 'center', fig.cap = "Dynamic Conditional Correlations: Resources \\label{DCCfullr}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_r_plot <- ggplot(dcc.time.var.cor %>% filter(grepl("Resources_", Pairs), !grepl("_Resources", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Resources") + 
  scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 years") + 
  annotate("text", 
           x = c(as.Date("2014-9-01"), as.Date("2018-12-01"), as.Date( "2019-10-01"), as.Date("2021-1-01"), as.Date("2021-08-01"), as.Date("2022-01-01"), as.Date("2023-03-01")), 
           y = -0.15, 
           label = c("Period 1", "Period 2", "Period 3", "Period 4", "Period 5", "Period 6", "Period 7"),
           angle = 90, 
           size = 9/.pt) +
  xlab("") +
  geom_rect(aes(xmin = as.Date("2014-11-01"), xmax = as.Date("2015-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)  +
  geom_rect(aes(xmin = as.Date("2019-02-01"), xmax = as.Date("2019-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date( "2019-12-01"), xmax = as.Date("2020-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) + 
  geom_rect(aes(xmin = as.Date("2021-3-01"), xmax = as.Date("2021-6-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2021-9-01"), xmax = as.Date("2021-11-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-2-01"), xmax = as.Date("2022-4-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-6-01"), xmax = as.Date("2022-12-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)
  
dcc.time.var.cor_r_plot

```

```{r DCCfullf,  warning =  FALSE, fig.align = 'center', fig.cap = "Dynamic Conditional Correlations: Financials \\label{DCCfullf}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_f_plot <- ggplot(dcc.time.var.cor %>% filter(grepl("Financials_", Pairs), !grepl("_Financials", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Financials") +
  scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 years") + 
  annotate("text", 
           x = c(as.Date("2014-9-01"), as.Date("2018-12-01"), as.Date( "2019-10-01"), as.Date("2021-1-01"), as.Date("2021-08-01"), as.Date("2022-01-01"), as.Date("2023-03-01")), 
           y = -0.11, 
           label = c("Period 1", "Period 2", "Period 3", "Period 4", "Period 5", "Period 6", "Period 7"),
           angle = 90, 
           size = 9/.pt) +
  xlab("") +
  geom_rect(aes(xmin = as.Date("2014-11-01"), xmax = as.Date("2015-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)  +
  geom_rect(aes(xmin = as.Date("2019-02-01"), xmax = as.Date("2019-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date( "2019-12-01"), xmax = as.Date("2020-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) + 
  geom_rect(aes(xmin = as.Date("2021-3-01"), xmax = as.Date("2021-6-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2021-9-01"), xmax = as.Date("2021-11-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-2-01"), xmax = as.Date("2022-4-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-6-01"), xmax = as.Date("2022-12-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)

dcc.time.var.cor_f_plot

```

```{r DCCfullp,  warning =  FALSE, fig.align = 'center', fig.cap = "Dynamic Conditional Correlations: Property \\label{DCCfullp}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_p_plot <- ggplot(dcc.time.var.cor %>% filter(grepl("Property_", Pairs), !grepl("_Property", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Property") +
  scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 years") + 
  annotate("text", 
           x = c(as.Date("2014-9-01"), as.Date("2018-12-01"), as.Date( "2019-10-01"), as.Date("2021-1-01"), as.Date("2021-08-01"), as.Date("2022-01-01"), as.Date("2023-03-01")), 
           y = 0, 
           label = c("Period 1", "Period 2", "Period 3", "Period 4", "Period 5", "Period 6", "Period 7"),
           angle = 90, 
           size = 9/.pt) +
  xlab("") +
  geom_rect(aes(xmin = as.Date("2014-11-01"), xmax = as.Date("2015-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)  +
  geom_rect(aes(xmin = as.Date("2019-02-01"), xmax = as.Date("2019-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date( "2019-12-01"), xmax = as.Date("2020-3-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) + 
  geom_rect(aes(xmin = as.Date("2021-3-01"), xmax = as.Date("2021-6-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2021-9-01"), xmax = as.Date("2021-11-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-2-01"), xmax = as.Date("2022-4-30"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01) +
  geom_rect(aes(xmin = as.Date("2022-6-01"), xmax = as.Date("2022-12-31"), ymin = -Inf, ymax = Inf), fill = "lightgray", alpha = 0.01)

dcc.time.var.cor_p_plot

```


## DCC Graphs for Load-Shedding Period


```{r DCClsf,  warning =  FALSE, fig.align = 'center', fig.cap = "Load-Shedding Dynamic Conditional Correlations: Financials \\label{DCClsf}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_ls_f_plot <- ggplot(dcc.time.var.cor_ls %>% filter(grepl("Financials_", Pairs), !grepl("_Financials", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Financials", subtitle = "Periods of Loadshedding") +
  facet_grid(~Period, scales = "free_x", space = "free_x") +
  scale_x_date(labels = scales::date_format("%Y %b"), date_breaks = "3 months") + 
  theme(axis.text = element_text(size = 7), strip.text.x = element_text(size = 8)) +
  xlab("") 
  

dcc.time.var.cor_ls_f_plot

```

```{r DCClsr,  warning =  FALSE, fig.align = 'center', fig.cap = "Load-Shedding Dynamic Conditional Correlations: Resources  \\label{DCClsr}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_ls_r_plot <- ggplot(dcc.time.var.cor_ls %>% filter(grepl("Resources_", Pairs), !grepl("_Resources", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Resources", subtitle = "Periods of Loadshedding") +
  facet_grid(~Period, scales = "free_x", space = "free_x") +
  scale_x_date(labels = scales::date_format("%Y %b"), date_breaks = "3 months") + 
  theme(axis.text = element_text(size = 7), strip.text.x = element_text(size = 8)) +
  xlab("") 
  

dcc.time.var.cor_ls_r_plot

```

```{r DCClsp,  warning =  FALSE, fig.align = 'center', fig.cap = "Load-Shedding Dynamic Conditional Correlations: Property  \\label{DCClsp}", fig.ext = 'png', fig.height = 3, fig.width = 6}

dcc.time.var.cor_ls_p_plot <- ggplot(dcc.time.var.cor_ls %>% filter(grepl("Property_", Pairs), !grepl("_Property", Pairs))) + 
  geom_line(aes(x = date, y = Rho, colour = Pairs)) + 
  theme_hc() + 
  #ggtitle("Dynamic Conditional Correlations: Property", subtitle = "Periods of Loadshedding") +
  facet_grid(~Period, scales = "free_x", space = "free_x") +
  scale_x_date(labels = scales::date_format("%Y %b"), date_breaks = "3 months") + 
  theme(axis.text = element_text(size = 7), strip.text.x = element_text(size = 8)) +
  xlab("") 
  

dcc.time.var.cor_ls_p_plot

```



## No Loadshedding Results

```{r, results='asis'}
star_fit.dcc_nls <- round(fit.dcc_nls@mfit$matcoef[rownames(fit.dcc_nls@mfit$matcoef) %like% 'omega|alpha1|beta1|dcca1|dccb1',, drop = FALSE],4)

star_fit.dcc_nls %>% kable()%>% kable_styling(font_size = 9) %>% 
  add_footnote("Note: This table displays the fit of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the periods that do not encounter loadshedding in this study.", notation="none")
```


```{r, results='asis'}

dccsummstat_nls <- dcc.time.var.cor_nls %>% spread(key = Pairs, value = Rho) %>% dplyr::select(c(Financials_Industrials, Financials_Resources, Financials_Property, Industrials_Resources, Industrials_Property, Resources_Property)) %>% 
  descr(stats = c("mean", "sd", "min", "max"), round.digits = 4)

colnames(dccsummstat_nls) <- c("Financials -> Industrials", "Financials -> Resources", "Financials -> Property", "Industrials -> Resources", "Industrials -> Property", "Resources -> Property")
round(dccsummstat_nls,4) %>%  t() %>% 
  kable() %>%
  kable_styling(font_size = 9) %>%
  add_footnote("Note: This table provides summary statistics of the dynamic conditional correlations of daily returns of different sectors within the ALSI over the periods that do not encounter loadshedding in this study.", notation="none")
```


